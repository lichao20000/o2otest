import Toggle from 'material-ui/Toggle';
import RaisedButton from 'material-ui/RaisedButton';

import Divider from 'material-ui/Divider';
import Select from 'react-select'
import Async from 'react-select/lib/Async'
import MultipleDatePicker from 'react-multiple-datepicker'




class Plan extends React.Component{
  constructor(props){
    super(props);
    let user_info = (((window.NS||{}).userInfo||{}).user_info||{});
    this.state = {
      loading: false ,
      sending: false,
      rows:[],
      user_info,
      tabid: 1,
      imported: false,
      percentCompleted: 0,
    }
  }
  
  onChoose(e){
    let file = e.target.files[0];
    this.setState({file: file, fileName:file.name, sending: true})
    let dataForm = new FormData();
    dataForm.append('file', file);
    let config = {
      onUploadProgress:(e)=>{
        let percentCompleted = Math.round( (e.loaded * 100) /e.total );
        this.setState({percentCompleted})
      },
      headers: { 'Content-Type': 'multipart/form-data' } 
    };
    axios.post('/upload/read_excel', dataForm, config)
      .then((resp)=>{
        let read = resp.data.result;
        let rows = []
        if(read){
          rows = resp.data.rows;
          if(rows.length){
            rows.splice(0,1)
          }
        }
        let percentCompleted = 0;
        this.setState({read, rows, percentCompleted, sending: false})
      }
      ).catch((err)=>{
        let percentCompleted = 0;
        let errMsg = '上传失败';
        this.setState({percentCompleted, errMsg, sending: false}) 
      })
  }

  renderForm(){
    let {tabid, imported, fileName, sending, loading }= this.state
    console.info(Async)
    return (<div>
      <h4 style={{fontSize:14, color:'#333'}}> 促销时间</h4>
      <MultipleDatePicker hintText="Landscape Dialog" mode="landscape" />

      <textarea style={{minWidth:'100%',
          minHeight: 50, marginBottom:10}}
          placeholder='8位数字日期(yyyymmdd)多条空格或换行隔开'
      />
      <h4 style={{fontSize:14, color:'#333'}}> 促销点</h4>
      <Async
        multi={true} 
        value={this.state.value}
        onChange={this.onChange}
        onValueClick={this.gotoUser}
        valueKey="id"
        labelKey="login" 
        loadOptions={this.getUsers}
        backspaceRemoves={this.state.backspaceRemoves} />
      <textarea style={{minWidth:'100%',
          minHeight: 100, marginBottom:10}}
          placeholder='促销点的系统ID(可以在上方搜索),区分范围内的促销点多条换行隔开'
      />
      <Divider />
      <h4 style={{fontSize:14, color:'#333'}}> 促销人员</h4>
      <Async
        multi={true} 
        value={this.state.value}
        onChange={this.onChange}
        onValueClick={this.gotoUser}
        valueKey="id"
        labelKey="login" 
        loadOptions={this.getUsers}
        backspaceRemoves={this.state.backspaceRemoves} />
      <textarea style={{minWidth:'100%',
        minHeight: 100, marginBottom:10}}
        placeholder='促销人员的手机号(11位)多条换行隔开'
      />
      <Divider />
     </div>) 
  }

  renderImport(){
    let {tabid, imported, fileName, sending, loading }= this.state
    return (
    <div> 
      <input ref='fileExcel' type='file' id='file' 
    onChange={this.onChoose.bind(this)}
    style={{display:'none'}}/>
      {sending?  [ <CircularProgress
        mode="determinate"
        size={20}
        thickness = {2} 
        style ={{dsplay:'inline-block'}} 
        value={percentCompleted} key = 'c' />,
        <div key='l' 
        style={{fontSize:12, 
            color:'#888',
            display:'inline-block', 
            width:60, textAlign:'center'}}>
        {percentCompleted}%</div>]:
        <RaisedButton  primary={true} label='选择文件'
        disabled = {sending || loading}
        onClick={(e)=>{this.refs['fileExcel'].click(e)}} /> 
      }
      <label style={{fontSize:14, color:'#333'}}> 
      {fileName} </label>
      </div>  )
  }

  render(){
    let  {tabid, imported, fileName, sending, loading }= this.state
    return (
      <div style ={{padding: 10}}>
        <h3>促销排产 </h3>
        <Toggle label='Excel导入' toggled={imported} 
        disabled = {sending || loading}
        onToggle ={(e, imported)=>{this.setState({imported})}} />
      { imported ? this.renderImport() : this.renderForm() }
      </div>
    ) 
  }

}

exports.Plan = Plan;






class PlanList extends React.Component{
  constructor(props){
    super(props);
    this.state = {
      loading: false ,
      sending: false,
      rows:[],
    }
  }


  render(){
    return (
      <div>  
      </div>  
    ) 
  
  }

}

exports.PlanList = PlanList
